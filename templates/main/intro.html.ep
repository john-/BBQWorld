% layout 'default';
% title 'Welcome';
<h2><%= $msg %></h2>

<canvas id="mycanvas" width="1000" height="200"></canvas>

<style>
  table {
    empty-cells: show;
    border: 1px solid #000;
  }

  table td,
  table th {
    min-width: 2em;
    min-height: 2em;
    border: 1px solid #000;
  }
</style>

<table id="status">
    <thead>
      <tr>
	<th colspan="4">PID</th>
	<th colspan="2">Temps</th>
	<th colspan="2">Intake</th>
      </tr>
      <tr>
	<th>P</th>
	<th>I</th>
	<th>D</th>
	<th>CO</th>
	<th>Ambient</th>
	<th>Internal</th>
	<th>Valve</th>
	<th>Fan</th>
      </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous">
</script>

<script type="text/javascript" src="smoothie.js"></script>

<script>
  var ws = new WebSocket('<%= url_for('status')->to_abs %>');
  ws.onmessage = function (event) {
    var stats = JSON.parse(event.data);
    $("#status tbody")
    .prepend('<tr><td>' + stats.pid.P + '</td>' +
                 '<td>' + stats.pid.I + '</td>' +
                 '<td>' + stats.pid.D + '</td>' +
                 '<td>' + stats.pid.CO + '</td>' +
                 '<td>' + stats.temps.ambient + '</td>' +
                 '<td>' + stats.temps.internal + '</td>' +
                 '<td>' + stats.intake.valve.duty + '</td>' +
                 '<td>' + stats.intake.fan.duty + '</td>'
    );

//    P.append(new Date().getTime(), stats.pid.P);
    I.append(new Date().getTime(), stats.pid.I);
  };

    var smoothie = new SmoothieChart();
    smoothie.streamTo(document.getElementById("mycanvas"));

//    var P = new TimeSeries();
    var I = new TimeSeries();

//    smoothie.addTimeSeries(P);
    smoothie.addTimeSeries(I);
</script>
